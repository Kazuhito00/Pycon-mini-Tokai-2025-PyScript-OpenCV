<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: 'Courier New', monospace;
            overflow: auto;
            font-size: 14.4px;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 12px;
            line-height: 1.3;
        }
        .keyword { color: #ff79c6; }
        .string { color: #f1fa8c; }
        .function { color: #50fa7b; }
        .comment { color: #6272a4; }
        .file-label {
            color: #333;
            font-weight: bold;
            margin-top: 12px;
            margin-bottom: 3px;
            font-size: 16.8px;
        }
    </style>
</head>
<body>
    <div class="file-label">demo.html (抜粋)</div>
    <pre><code><span class="keyword">&lt;link</span> rel=<span class="string">"stylesheet"</span> href=<span class="string">"https://pyscript.net/releases/2025.10.3/core.css"</span><span class="keyword">&gt;</span>
<span class="keyword">&lt;script</span> type=<span class="string">"module"</span> src=<span class="string">"https://pyscript.net/releases/2025.10.3/core.js"</span><span class="keyword">&gt;&lt;/script&gt;</span>

<span class="keyword">&lt;py-config</span> src=<span class="string">"./pyscript.toml"</span><span class="keyword">&gt;&lt;/py-config&gt;</span>
<span class="keyword">&lt;py-script</span> src=<span class="string">"./main.py"</span><span class="keyword">&gt;&lt;/py-script&gt;</span>
<span class="keyword">&lt;video</span> id=<span class="string">"myCamera"</span> width=<span class="string">"640"</span> height=<span class="string">"480"</span> autoplay style=<span class="string">"display:none;"</span><span class="keyword">&gt;&lt;/video&gt;</span>
<span class="keyword">&lt;canvas</span> id=<span class="string">"canvas"</span> width=<span class="string">"544"</span> height=<span class="string">"408"</span><span class="keyword">&gt;&lt;/canvas&gt;</span></code></pre>

    <div class="file-label">main.py (抜粋)</div>
    <pre><code><span class="keyword">import</span> time, asyncio, js, cv2, numpy <span class="keyword">as</span> np
<span class="keyword">from</span> js <span class="keyword">import</span> ImageData, Uint8ClampedArray
<span class="keyword">from</span> yolox <span class="keyword">import</span> YOLOX, letterbox, vis

<span class="comment"># (中略: ビデオ・キャンバス要素の取得)</span>

<span class="comment"># YOLOX準備</span>
model = <span class="function">YOLOX</span>(modelPath=<span class="string">"./model/yolox_nano.onnx"</span>, input_size=(<span class="string">416</span>, <span class="string">416</span>), <span class="comment">...</span>)

camera_stream = <span class="keyword">None</span>
is_running = <span class="keyword">True</span>

<span class="keyword">async def</span> <span class="function">start_camera</span>():
    <span class="keyword">global</span> camera_stream
    camera_stream = <span class="keyword">await</span> js.navigator.mediaDevices.<span class="function">getUserMedia</span>(<span class="comment">...</span>)
    video.srcObject = camera_stream
    <span class="keyword">await</span> <span class="function">process_frames</span>()

<span class="keyword">def</span> <span class="function">stop_camera</span>():
    <span class="keyword">global</span> camera_stream, is_running
    is_running = <span class="keyword">False</span>
    <span class="keyword">if</span> camera_stream:
        tracks = camera_stream.<span class="function">getTracks</span>()
        <span class="keyword">for</span> track <span class="keyword">in</span> tracks:
            track.<span class="function">stop</span>()
        video.srcObject = <span class="keyword">None</span>

<span class="keyword">async def</span> <span class="function">process_frames</span>():
    <span class="keyword">while</span> is_running:
        <span class="comment"># ビデオフレームを取得</span>
        context.<span class="function">drawImage</span>(video, <span class="string">0</span>, <span class="string">0</span>, canvas.width, canvas.height)
        image_data = context.<span class="function">getImageData</span>(<span class="string">0</span>, <span class="string">0</span>, canvas.width, canvas.height)

        <span class="comment"># NumPy配列に変換</span>
        image = np.<span class="function">frombuffer</span>(image_data.data.to_py(), dtype=np.uint8)
        image = image.<span class="function">reshape</span>((canvas.height, canvas.width, <span class="string">4</span>))
        image = cv2.<span class="function">cvtColor</span>(image, cv2.COLOR_RGBA2BGR)

        <span class="comment"># YOLOX推論</span>
        input_blob, ratio = <span class="function">letterbox</span>(image, yolox_input_size)
        preds = model.<span class="function">infer</span>(input_blob)
        image = <span class="function">vis</span>(preds, image, ratio)

        <span class="comment"># (中略: 処理時間の表示)</span>

        <span class="comment"># 結果をキャンバスに描画</span>
        image = cv2.<span class="function">cvtColor</span>(image, cv2.COLOR_BGR2RGBA)
        buffer = image.<span class="function">flatten</span>().<span class="function">tobytes</span>()
        js_image = ImageData.<span class="function">new</span>(<span class="function">Uint8ClampedArray</span>.<span class="function">new</span>(buffer), width, height)
        context.<span class="function">putImageData</span>(js_image, <span class="string">0</span>, <span class="string">0</span>)
        <span class="keyword">await</span> asyncio.<span class="function">sleep</span>(<span class="string">0</span>)

<span class="comment"># JavaScriptから呼び出せるようにする</span>
js.window.stopCamera = stop_camera
asyncio.<span class="function">ensure_future</span>(<span class="function">start_camera</span>())</code></pre>

    <div class="file-label">pyscript.toml</div>
    <pre><code>packages = [<span class="string">"opencv-python"</span>, <span class="string">"numpy"</span>]
name = <span class="string">"Test"</span>
[[fetch]]
files = [<span class="string">"./yolox.py"</span>, <span class="string">"./model/yolox_nano.onnx"</span>]</code></pre>
</body>
</html>
